# DQ3 グラフィックス再調査ノート (2025-10-05)

## 1. 再現ログとダンプ
- 実行コマンド: `HEADLESS=1 HEADLESS_FRAMES=400 DUMP_REGISTER_SUMMARY=1 ./target/release/snes_emulator roms/dq3.sfc`
- 出力ログ: `docs/debug/dq3_visual_issue/headless_frame400.log`
- レジスタ集計を JSON 化: `docs/debug/dq3_visual_issue/register_summary.json`

## 2. BG レイヤ構成の観測結果 (TODO 3)
- 全フレームで `TM (main) = 0x34` → BG3 + OBJ のみ有効、BG1/BG2 は常に無効。
- `BG mode = 5` のまま固定だが、ログには BG1/BG2 タイルベースも 0x7000 と表示される一方で TM のビットは 0。
- `BG3 config`: `tile_base=0x4000`, `map_base=0x9400`, `screen=64x32` が継続。
- 登録された VRAM ブロック (4KB 単位) は 0x0000〜0x7800 に均等に分布しており、BG1/BG2 用データらしき領域も埋まっているが、描画には使われていない。
- OBJ は常時有効 (`OAM usage` ≒ 512/544) だが、Headless ログではスプライト溢れ (`OBJ overflow_lines=151`) が継続している。

**仮説**: Mode 5 特有の「メインスクリーン/サブスクリーン切り替え」または BG3 をタイトル描画に使う特殊レイアウトで、BG1/BG2 を無効のままにしてしまっている可能性。BG1/BG2 を有効化する条件が満たされていない、もしくは `TM` レジスタ更新がキャンセルされている。

## 3. CGRAM / パレット挙動 (TODO 4)
- 400 フレーム通して CGRAM 書き込みは **LOW バイト (0x??AC)** のみで、ハイバイトが入っていない → 実質的に 0x00AC (= 0xAC00?) が多数回復写。
- `REGISTER SUMMARY` によると Frame 60 では `CGRAM usage: 0/512`、Frame 120 以降は 26 バイトに増えるが値はフォールバック注入のみ。
- `logs` 内にゲーム側が本来転送すべき 512 バイト分のパレットが確認できず、`CGRAM=0 writes` の統計も fallback 運用を示唆。

**仮説**: フォールバックパレットを投入しているものの、BG1/BG2 が無効なため本来のタイトル背景 (BG1/BG2) が描かれず、BG3+OBJ のみが表示されている。この状態だとウィンドウ実行では「色付きブロックが散乱した画面」に見える。

## 4. VRAM スナップショット (TODO 2 補足)
`register_summary.json` を参照すると、各 60 フレームごとの VRAM ブロック使用量はほぼ一定で、特に 0x7000/0x7800 といった BG タイルバンクが最も密度高い。CSV 等の生成は未実装だが JSON 化で差分追跡は可能。

## 5. 既知の制約・未対応事項
- ウィンドウモードでの画面キャプチャは CLI サンドボックス上で取得できず、実際の乱れは再現者の目視レポートに依存。
- 他エミュレータ (bsnes/higan) を実行できる環境が無いため、フレーム 200/400 の基準画像比較は未実施。外部での補完が必要。
- 修正実装は未着手。TM/BG 有効化タイミングと CGRAM 転送の再検証が次のステップ。

## 6. 次のアクション候補
1. `TM` レジスタ書き込みをトレース (`DEBUG_RENDER_STATE` など) し、BG1/BG2 が OFF のままになる理由を特定。
2. Mode 5 で BG3 をサブスクリーン側に回す処理が正しいか (`CGWSEL`, `CGADSUB`) を検証。
3. フォールバックパレット注入の条件を緩和し、ハイバイトも含めた 15-bit パレットを仮生成して色崩れ原因を切り分ける。
4. 他エミュレータのスクリーンショットと同一フレームを比較するための `HEADLESS_FRAME_DUMP` 仕組みを追加。
